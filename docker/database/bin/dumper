#!/bin/bash

mkdir -p /database/dumps

usr="root"
pass="$MARIADB_ROOT_PASSWORD"
dbhost="$DB_HOST"
dbname="$MARIADB_DATABASE"

dumppath="/database/dumps/"
structure_dump_name="1_$(echo $dbname)_structure.sql"
data_dump_name="2_$(echo $dbname)_data.sql"
tar_file="$(date +%Y-%d-%m"_"%H:%M:%S)-dump.tar.gz"


customlog () {
  now="$(date +%F) $(date +"%T")"
  echo "$now: $1"
}

mkdir -p  "$dumppath"

customlog "creation of $structure_dump_name"
# Structure only
mariadb-dump -u$usr -p$pass -h $dbhost --no-data  $dbname > $dumppath/$structure_dump_name
customlog "end of creation of $structure_dump_name"

customlog "creation of $data_dump_name"
# separate each insert
echo "SET FOREIGN_KEY_CHECKS=0;" > $dumppath/$data_dump_name
mariadb-dump -u$usr -p$pass -h $dbhost $dbname --skip-triggers --compact --no-create-info --extended-insert=FALSE  >> $dumppath/$data_dump_name
echo "SET FOREIGN_KEY_CHECKS=1;" >> $dumppath/$data_dump_name
customlog "end of creation of $data_dump_name"

tar czf $dumppat/$tar_file $dumppat/$structure_dump_name $dumppat/$data_dump_name